<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;Hi&nbsp;Jannik,&lt;br&gt;&lt;br&gt;&lt;/div&gt;General&nbsp;purpose&nbsp;double&nbsp;buffering&nbsp;of&nbsp;data&nbsp;is&nbsp;something&nbsp;I&#39;ve&nbsp;considered&nbsp;in&nbsp;the&nbsp;past&nbsp;but&nbsp;not&nbsp;attempted&nbsp;to&nbsp;implement&nbsp;into&nbsp;the&nbsp;core&nbsp;OSG&nbsp;as&nbsp;it&nbsp;introduces&nbsp;a&nbsp;range&nbsp;of&nbsp;complexities&nbsp;in&nbsp;implementation&nbsp;and&nbsp;API. &nbsp;There&nbsp;are&nbsp;places&nbsp;in&nbsp;the&nbsp;OSG&nbsp;where&nbsp;buffering&nbsp;is&nbsp;done&nbsp;locally&nbsp;but&nbsp;in&nbsp;general&nbsp;these&nbsp;are&nbsp;areas&nbsp;where&nbsp;the&nbsp;implementation&nbsp;is&nbsp;lightweight&nbsp;and&nbsp;there&nbsp;is&nbsp;a&nbsp;clear&nbsp;benefit.&lt;br&gt;&lt;br&gt;&lt;/div&gt;In&nbsp;your&nbsp;case&nbsp;it&#39;s&nbsp;cool&nbsp;that&nbsp;you&#39;ve&nbsp;found&nbsp;a&nbsp;way&nbsp;of&nbsp;implementing&nbsp;and&nbsp;got&nbsp;a&nbsp;performance&nbsp;benefit. &nbsp;It&#39;s&nbsp;a&nbsp;complexity&nbsp;that&nbsp;most&nbsp;users&nbsp;haven&#39;t&nbsp;tried&nbsp;to&nbsp;tackle&nbsp;before,&nbsp;but&nbsp;I&nbsp;suspect&nbsp;this&nbsp;is&nbsp;probably&nbsp;partly&nbsp;down&nbsp;to&nbsp;not&nbsp;having&nbsp;the&nbsp;same&nbsp;bottlenecks&nbsp;that&nbsp;you&nbsp;are&nbsp;probably&nbsp;seeing.&lt;br&gt;&lt;br&gt;&lt;/div&gt;I&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;bottlenecks&nbsp;in&nbsp;your&nbsp;app,&nbsp;but&nbsp;for&nbsp;DrawThreadPerContext&nbsp;to&nbsp;make&nbsp;such&nbsp;big&nbsp;difference&nbsp;in&nbsp;performance&nbsp;it&nbsp;would&nbsp;suggest&nbsp;that&nbsp;your&nbsp;are&nbsp;CPU&nbsp;bound. &nbsp;Are&nbsp;you&nbsp;update,&nbsp;cull,&nbsp;draw&nbsp;dispatch&nbsp;or&nbsp;draw&nbsp;GPU&nbsp;bound? &nbsp;Use&nbsp;the&nbsp;osgViewer::StatsHandler&nbsp;to&nbsp;show&nbsp;the&nbsp;relatively&nbsp;load&nbsp;on&nbsp;screen. &nbsp;Most&nbsp;scene&nbsp;graphs&nbsp;app&nbsp;will&nbsp;have&nbsp;a&nbsp;pretty&nbsp;light&nbsp;update,&nbsp;a&nbsp;modest&nbsp;cull&nbsp;and&nbsp;draw&nbsp;dispatch. &nbsp;If&nbsp;any&nbsp;of&nbsp;these&nbsp;phases&nbsp;are&nbsp;the&nbsp;bottleneck&nbsp;then&nbsp;look&nbsp;to&nbsp;resolving&nbsp;these&nbsp;might&nbsp;be&nbsp;the&nbsp;key&nbsp;to&nbsp;getting&nbsp;best&nbsp;performance&nbsp;rather&nbsp;than&nbsp;adding&nbsp;double&nbsp;buffering.&lt;br&gt;&lt;br&gt;&lt;/div&gt;Also,&nbsp;make&nbsp;sure&nbsp;that&nbsp;you&nbsp;are&nbsp;using&nbsp;a&nbsp;release&nbsp;build&nbsp;when&nbsp;performance&nbsp;profiling,&nbsp;the&nbsp;results&nbsp;you&nbsp;get&nbsp;in&nbsp;debug&nbsp;make&nbsp;a&nbsp;huge&nbsp;difference&nbsp;and&nbsp;can&nbsp;totally&nbsp;distort&nbsp;the&nbsp;relative&nbsp;cost&nbsp;of&nbsp;different&nbsp;phases.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Cheers,&lt;br&gt;&lt;/div&gt;Robert.&lt;br&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;14&nbsp;April&nbsp;2015&nbsp;at&nbsp;18:28,&nbsp;Jannik&nbsp;Heller&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:scrawl@baseoftrash.de&quot;&nbsp;target=&quot;_blank&quot;&gt;scrawl@baseoftrash.de&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;Hi&nbsp;OSG&nbsp;friends,&lt;br&gt;<br>
&lt;br&gt;<br>
A&nbsp;common&nbsp;challenge&nbsp;for&nbsp;OSG&nbsp;users&nbsp;are&nbsp;the&nbsp;implications&nbsp;of&nbsp;the&nbsp;viewer&nbsp;threading&nbsp;model&nbsp;-&nbsp;by&nbsp;default&nbsp;the&nbsp;viewer.frame()&nbsp;will&nbsp;return&nbsp;before&nbsp;the&nbsp;draw&nbsp;dispatch&nbsp;is&nbsp;complete,&nbsp;meaning&nbsp;users&nbsp;(and&nbsp;the&nbsp;OSG)&nbsp;can&nbsp;start&nbsp;preparing&nbsp;the&nbsp;next&nbsp;frame&nbsp;before&nbsp;the&nbsp;current&nbsp;frame&nbsp;has&nbsp;completed.&nbsp;However,&nbsp;if&nbsp;you&nbsp;attempt&nbsp;to&nbsp;change&nbsp;a&nbsp;StateSet&nbsp;or&nbsp;Drawable&nbsp;in&nbsp;the&nbsp;frame&nbsp;update,&nbsp;you&nbsp;run&nbsp;the&nbsp;risk&nbsp;of&nbsp;modifying&nbsp;data&nbsp;that&nbsp;the&nbsp;OSG&nbsp;is&nbsp;still&nbsp;working&nbsp;with&nbsp;in&nbsp;a&nbsp;background&nbsp;thread,&nbsp;resulting&nbsp;in&nbsp;crashes.&lt;br&gt;<br>
Often&nbsp;times&nbsp;you&nbsp;will&nbsp;see&nbsp;code&nbsp;dealing&nbsp;with&nbsp;this&nbsp;by&nbsp;setting&nbsp;the&nbsp;DataVariance&nbsp;of&nbsp;the&nbsp;object&nbsp;to&nbsp;DYNAMIC.&nbsp;Unfortunately&nbsp;as&nbsp;result&nbsp;the&nbsp;draw&nbsp;dispatch&nbsp;has&nbsp;to&nbsp;complete&nbsp;before&nbsp;the&nbsp;frame()&nbsp;returns,&nbsp;for&nbsp;me&nbsp;this&nbsp;dropped&nbsp;the&nbsp;frame&nbsp;rate&nbsp;in&nbsp;half.&lt;br&gt;<br>
Recently&nbsp;I&nbsp;developed&nbsp;a&nbsp;more&nbsp;efficient&nbsp;solution&nbsp;for&nbsp;dealing&nbsp;with&nbsp;this&nbsp;and&nbsp;would&nbsp;like&nbsp;to&nbsp;hear&nbsp;your&nbsp;thoughts.&lt;br&gt;<br>
The&nbsp;idea&nbsp;is&nbsp;similar&nbsp;to&nbsp;&quot;double&nbsp;buffering&quot;&nbsp;with&nbsp;the&nbsp;framebuffer&nbsp;-&nbsp;you&nbsp;create&nbsp;two&nbsp;copies&nbsp;of&nbsp;the&nbsp;data&nbsp;on&nbsp;start,&nbsp;one&nbsp;copy&nbsp;is&nbsp;write&nbsp;only,&nbsp;another&nbsp;copy&nbsp;is&nbsp;read&nbsp;only,&nbsp;and&nbsp;when&nbsp;the&nbsp;frame&nbsp;completes&nbsp;the&nbsp;roles&nbsp;are&nbsp;swapped.&nbsp;You&nbsp;can&nbsp;implement&nbsp;this&nbsp;idea&nbsp;for&nbsp;both&nbsp;Drawables&nbsp;and&nbsp;StateSets:&lt;br&gt;<br>
-&nbsp;Dynamic&nbsp;Drawables&nbsp;(RigGeometry,&nbsp;MorphGeometry,&nbsp;etc):&nbsp;create&nbsp;a&nbsp;deep&nbsp;copy&nbsp;of&nbsp;the&nbsp;Drawable,&nbsp;decorate&nbsp;both&nbsp;Drawables&nbsp;with&nbsp;a&nbsp;FrameSwitch&nbsp;node.&nbsp;A&nbsp;FrameSwitch&nbsp;node&nbsp;is&nbsp;a&nbsp;variant&nbsp;of&nbsp;Group&nbsp;that&nbsp;only&nbsp;traverses&nbsp;even&nbsp;or&nbsp;non-even&nbsp;children&nbsp;based&nbsp;on&nbsp;the&nbsp;current&nbsp;FrameStamp.&nbsp;Code&nbsp;(&lt;a&nbsp;href=&quot;https://github.com/OpenMW/openmw/blob/f7da9796692e14c79632cb85fa75a90b082cd863/components/nifosg/nifloader.cpp#L179&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/OpenMW/openmw/blob/f7da9796692e14c79632cb85fa75a90b082cd863/components/nifosg/nifloader.cpp#L179&lt;/a&gt;)&lt;br&gt;<br>
-&nbsp;Dynamic&nbsp;StateSets:&nbsp;Create&nbsp;two&nbsp;copies&nbsp;of&nbsp;the&nbsp;StateSet&nbsp;on&nbsp;start,&nbsp;then&nbsp;every&nbsp;frame&nbsp;in&nbsp;a&nbsp;NodeCallback&nbsp;swap&nbsp;the&nbsp;roles&nbsp;of&nbsp;these&nbsp;StateSets,&nbsp;apply&nbsp;changes&nbsp;to&nbsp;the&nbsp;first&nbsp;StateSet,&nbsp;then&nbsp;set&nbsp;the&nbsp;currently&nbsp;active&nbsp;StateSet&nbsp;on&nbsp;the&nbsp;Node.&nbsp;Code&nbsp;(&lt;a&nbsp;href=&quot;https://github.com/scrawl/openmw/blob/osg/components/sceneutil/statesetupdater.cpp#L8&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/scrawl/openmw/blob/osg/components/sceneutil/statesetupdater.cpp#L8&lt;/a&gt;)&lt;br&gt;<br>
&lt;br&gt;<br>
There&nbsp;are&nbsp;some&nbsp;downsides&nbsp;to&nbsp;this&nbsp;approach&nbsp;(mostly&nbsp;that&nbsp;for&nbsp;data&nbsp;that&nbsp;is&nbsp;just&nbsp;rarely&nbsp;changing,&nbsp;you&nbsp;have&nbsp;to&nbsp;apply&nbsp;every&nbsp;change&nbsp;twice),&nbsp;but&nbsp;other&nbsp;than&nbsp;that&nbsp;it&nbsp;works&nbsp;beautifully&nbsp;and&nbsp;now&nbsp;I&#39;ve&nbsp;got&nbsp;2x&nbsp;the&nbsp;framerate&nbsp;again.&lt;br&gt;<br>
&lt;br&gt;<br>
I&#39;m&nbsp;curious&nbsp;how&nbsp;the&nbsp;OSG&nbsp;veterans&nbsp;are&nbsp;dealing&nbsp;with&nbsp;this.&nbsp;Anything&nbsp;I&#39;ve&nbsp;missed?&lt;br&gt;<br>
&lt;br&gt;<br>
Cheers&lt;br&gt;<br>
Jannik&lt;br&gt;<br>
&lt;br&gt;<br>
------------------&lt;br&gt;<br>
Read&nbsp;this&nbsp;topic&nbsp;online&nbsp;here:&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://forum.openscenegraph.org/viewtopic.php?p=63390#63390&quot;&nbsp;target=&quot;_blank&quot;&gt;http://forum.openscenegraph.org/viewtopic.php?p=63390#63390&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
osg-users&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:osg-users@lists.openscenegraph.org&quot;&gt;osg-users@lists.openscenegraph.org&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.openscenegraph.org/listinfo.cgi/osg-users-openscenegraph.org&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.openscenegraph.org/listinfo.cgi/osg-users-openscenegraph.org&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
