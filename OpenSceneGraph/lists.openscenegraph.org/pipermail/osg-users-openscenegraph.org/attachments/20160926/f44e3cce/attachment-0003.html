<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;&nbsp;charset=windows-1252&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&nbsp;bgcolor=&quot;#FFFFFF&quot;&nbsp;text=&quot;#000000&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Hi&nbsp;Robert,&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
cite=&quot;mid:CAFN7Y+Wb2iEobgiG7HBE3ojd35SmBO3g=-RgSEk1uE=Rv+639g@mail.gmail.com&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;Hi&nbsp;All,<br>
<br>
I&nbsp;have&nbsp;taken&nbsp;Christoph's&nbsp;test&nbsp;problem&nbsp;and&nbsp;reproduced&nbsp;the&nbsp;affinity<br>
issue&nbsp;on&nbsp;my&nbsp;Kubuntu&nbsp;16.04,&nbsp;so&nbsp;this&nbsp;is&nbsp;useful&nbsp;first&nbsp;step.<br>
<br>
I've&nbsp;also&nbsp;reviewed&nbsp;the&nbsp;OpenThreads&nbsp;code,&nbsp;so&nbsp;have&nbsp;a&nbsp;better&nbsp;idea&nbsp;of&nbsp;the<br>
code&nbsp;in&nbsp;question.&nbsp;&nbsp;Please&nbsp;note&nbsp;that&nbsp;I'm&nbsp;not&nbsp;the&nbsp;author&nbsp;of&nbsp;OpenThreads,<br>
the&nbsp;project&nbsp;just&nbsp;fell&nbsp;on&nbsp;my&nbsp;shoulders&nbsp;to&nbsp;maintain.&nbsp;&nbsp;Some&nbsp;of&nbsp;the&nbsp;code<br>
in&nbsp;OpenThreads&nbsp;pthread&nbsp;side&nbsp;made&nbsp;me&nbsp;curious&nbsp;so&nbsp;I&nbsp;modified&nbsp;Christoph's<br>
code&nbsp;to&nbsp;added&nbsp;a&nbsp;code&nbsp;path&nbsp;using&nbsp;OpenThreads&nbsp;rather&nbsp;than&nbsp;C++11&nbsp;threads<br>
used&nbsp;in&nbsp;Christoph's&nbsp;code&nbsp;and&nbsp;command&nbsp;line&nbsp;options&nbsp;to&nbsp;toggle&nbsp;between<br>
the&nbsp;two,&nbsp;toggle&nbsp;beteween&nbsp;viewer&nbsp;running&nbsp;SingleThreaded&nbsp;or&nbsp;with<br>
defaults&nbsp;(will&nbsp;be&nbsp;DrawThreadPerContext).&nbsp;&nbsp;Attached&nbsp;is&nbsp;a&nbsp;CmakeLists.txt<br>
file&nbsp;and&nbsp;main.cpp.<br>
<br>
For&nbsp;the&nbsp;OpenThreads&nbsp;pathway&nbsp;I&nbsp;get&nbsp;the&nbsp;exactly&nbsp;the&nbsp;same&nbsp;performance<br>
when&nbsp;running&nbsp;the&nbsp;viewer&nbsp;single&nbsp;theaded&nbsp;or&nbsp;multi-threaded.<br>
<br>
&nbsp;time&nbsp;./threadtest&nbsp;--ot&nbsp;--SingleThreaded<br>
Thread&nbsp;0x142df50&nbsp;done<br>
Thread&nbsp;0x1427750&nbsp;done<br>
Thread&nbsp;0x1427690&nbsp;done<br>
Thread&nbsp;0x142dcf0&nbsp;done<br>
Thread&nbsp;0x142e1f0&nbsp;done<br>
Thread&nbsp;0x142e0a0&nbsp;done<br>
Thread&nbsp;0x142edc0&nbsp;done<br>
Thread&nbsp;0x142e5e0&nbsp;done<br>
Thread&nbsp;0x142ec70&nbsp;done<br>
Thread&nbsp;0x142e9d0&nbsp;done<br>
Thread&nbsp;0x142e340&nbsp;done<br>
Thread&nbsp;0x142e490&nbsp;done<br>
Thread&nbsp;0x142de20&nbsp;done<br>
Thread&nbsp;0x142e880&nbsp;done<br>
Thread&nbsp;0x142e730&nbsp;done<br>
Thread&nbsp;0x142eb20&nbsp;done<br>
<br>
real&nbsp;&nbsp;&nbsp;&nbsp;0m15.463s<br>
user&nbsp;&nbsp;&nbsp;&nbsp;1m59.612s<br>
sys&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0m0.044s<br>
<br>
<br>
For&nbsp;the&nbsp;C++11&nbsp;threads&nbsp;I&nbsp;get&nbsp;far&nbsp;worse&nbsp;performance&nbsp;when&nbsp;running&nbsp;single<br>
theaded&nbsp;vs&nbsp;multi-threaded:<br>
<br>
$&nbsp;time&nbsp;./threadtest&nbsp;--SingleThreaded<br>
Thread&nbsp;7&nbsp;done<br>
Thread&nbsp;11&nbsp;done<br>
Thread&nbsp;10&nbsp;done<br>
Thread&nbsp;13&nbsp;done<br>
Thread&nbsp;12&nbsp;done<br>
Thread&nbsp;6&nbsp;done<br>
Thread&nbsp;9&nbsp;done<br>
Thread&nbsp;8&nbsp;done<br>
Thread&nbsp;14&nbsp;done<br>
Thread&nbsp;15&nbsp;done<br>
Thread&nbsp;5&nbsp;done<br>
Thread&nbsp;4&nbsp;done<br>
Thread&nbsp;3&nbsp;done<br>
Thread&nbsp;2&nbsp;done<br>
Thread&nbsp;1&nbsp;done<br>
Thread&nbsp;0&nbsp;done<br>
<br>
real&nbsp;&nbsp;&nbsp;&nbsp;1m22.315s<br>
user&nbsp;&nbsp;&nbsp;&nbsp;1m22.064s<br>
sys&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0m0.044s<br>
<br>
<br>
So&nbsp;the&nbsp;code&nbsp;in&nbsp;OpenThreads&nbsp;to&nbsp;set&nbsp;the&nbsp;affinity&nbsp;mask&nbsp;by&nbsp;default&nbsp;for<br>
it's&nbsp;own&nbsp;threads&nbsp;resolve&nbsp;the&nbsp;issue&nbsp;completely&nbsp;(note,&nbsp;the<br>
OpenThreads::Thread&nbsp;that&nbsp;I&nbsp;created&nbsp;above&nbsp;don't&nbsp;set&nbsp;affinity,&nbsp;so&nbsp;they<br>
are&nbsp;free&nbsp;for&nbsp;the&nbsp;OS&nbsp;to&nbsp;place&nbsp;them.)&nbsp;&nbsp;This&nbsp;may&nbsp;also&nbsp;be&nbsp;why&nbsp;most&nbsp;users<br>
don't&nbsp;see&nbsp;these&nbsp;issues.<br>
<br>
This&nbsp;isolates&nbsp;the&nbsp;issues&nbsp;to&nbsp;users&nbsp;who&nbsp;use&nbsp;non&nbsp;OpenThreads&nbsp;threads&nbsp;when<br>
these&nbsp;threads&nbsp;are&nbsp;created&nbsp;after&nbsp;the&nbsp;viewer&nbsp;has&nbsp;been&nbsp;realized&nbsp;and&nbsp;don't<br>
set&nbsp;thread&nbsp;affinity&nbsp;for&nbsp;there&nbsp;threads&nbsp;themselves.&nbsp;&nbsp;That's&nbsp;three&nbsp;sets<br>
of&nbsp;conditions&nbsp;that&nbsp;any&nbsp;one&nbsp;be&nbsp;changed&nbsp;and&nbsp;the&nbsp;problem&nbsp;will&nbsp;be&nbsp;entirely<br>
resolved.&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;problem&nbsp;as&nbsp;Christoph&nbsp;mentioned&nbsp;are&nbsp;threads&nbsp;which&nbsp;are&nbsp;created&nbsp;by<br>
&nbsp;&nbsp;&nbsp;&nbsp;C++11&nbsp;features&nbsp;such&nbsp;as&nbsp;std::async.&nbsp;One&nbsp;simply&nbsp;doesn't&nbsp;have&nbsp;any<br>
&nbsp;&nbsp;&nbsp;&nbsp;control&nbsp;over&nbsp;them&nbsp;and&nbsp;cannot&nbsp;set&nbsp;any&nbsp;affinity&nbsp;whatsoever.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
cite=&quot;mid:CAFN7Y+Wb2iEobgiG7HBE3ojd35SmBO3g=-RgSEk1uE=Rv+639g@mail.gmail.com&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;<br>
While&nbsp;not&nbsp;ideal&nbsp;that&nbsp;this&nbsp;issue&nbsp;exists&nbsp;at&nbsp;all&nbsp;at&nbsp;least&nbsp;we&nbsp;now&nbsp;have&nbsp;a<br>
handle&nbsp;on&nbsp;it.&nbsp;&nbsp;Given&nbsp;the&nbsp;issue&nbsp;only&nbsp;occurs&nbsp;with&nbsp;a&nbsp;very&nbsp;specific&nbsp;set&nbsp;of<br>
usage&nbsp;I&nbsp;don't&nbsp;think&nbsp;there&nbsp;is&nbsp;any&nbsp;reason&nbsp;for&nbsp;sweeping&nbsp;changes&nbsp;to&nbsp;the<br>
core&nbsp;OSG,&nbsp;or&nbsp;changes&nbsp;to&nbsp;the&nbsp;defaults.&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Would&nbsp;a&nbsp;small&nbsp;function&nbsp;to&nbsp;enable/disable&nbsp;the&nbsp;affinity&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;SingleThreaded&nbsp;mode&nbsp;be&nbsp;a&nbsp;big&nbsp;breaking&nbsp;change?&nbsp;Defaulting&nbsp;to&nbsp;using<br>
&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;affinity&nbsp;mask,&nbsp;making&nbsp;it&nbsp;up&nbsp;to&nbsp;the&nbsp;advanced&nbsp;user&nbsp;to&nbsp;sacrifice<br>
&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;performance.&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;would&nbsp;argue&nbsp;that&nbsp;the&nbsp;the&nbsp;issue&nbsp;isn't&nbsp;that&nbsp;specific&nbsp;when&nbsp;seen&nbsp;in&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;greater&nbsp;context.&nbsp;In&nbsp;my&nbsp;case&nbsp;OSG&nbsp;is&nbsp;used&nbsp;behind&nbsp;an&nbsp;interface,&nbsp;so&nbsp;it<br>
&nbsp;&nbsp;&nbsp;&nbsp;might&nbsp;not&nbsp;be&nbsp;possible&nbsp;to&nbsp;use&nbsp;create&nbsp;threads&nbsp;before&nbsp;the&nbsp;viewer.&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Also&nbsp;it&nbsp;simply&nbsp;feels&nbsp;like&nbsp;an&nbsp;inappropriate&nbsp;side-effect&nbsp;which&nbsp;is<br>
&nbsp;&nbsp;&nbsp;&nbsp;buried&nbsp;without&nbsp;having&nbsp;control/access&nbsp;over/to&nbsp;it.&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Cheers&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Sebastian&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
cite=&quot;mid:CAFN7Y+Wb2iEobgiG7HBE3ojd35SmBO3g=-RgSEk1uE=Rv+639g@mail.gmail.com&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;<br>
<br>
Robert.<br>
&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;fieldset&nbsp;class=&quot;mimeAttachmentHeader&quot;&gt;&lt;/fieldset&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;_______________________________________________<br>
osg-users&nbsp;mailing&nbsp;list<br>
&lt;a&nbsp;class=&quot;moz-txt-link-abbreviated&quot;&nbsp;href=&quot;mailto:osg-users@lists.openscenegraph.org&quot;&gt;osg-users@lists.openscenegraph.org&lt;/a&gt;<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;http://lists.openscenegraph.org/listinfo.cgi/osg-users-openscenegraph.org&quot;&gt;http://lists.openscenegraph.org/listinfo.cgi/osg-users-openscenegraph.org&lt;/a&gt;<br>
&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
