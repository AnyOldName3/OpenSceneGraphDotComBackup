<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;Fabian,&lt;br&gt;&lt;/div&gt; &lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;My&nbsp;build&nbsp;is&nbsp;using&nbsp;static&nbsp;osg,&nbsp;static&nbsp;osg-plugins&nbsp;and&nbsp;link&nbsp;time&nbsp;optimization.&lt;div&gt;I&nbsp;created&nbsp;an&nbsp;address&nbsp;sanitizer&nbsp;enabled&nbsp;build.&lt;/div&gt;&lt;div&gt;It&nbsp;exhibits&nbsp;a&nbsp;heap-use-after-free.&lt;br&gt;&lt;/div&gt;I&nbsp;will&nbsp;try&nbsp;to&nbsp;further&nbsp;investigate&nbsp;this&nbsp;week.&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;=================================================================&lt;br&gt;==11872==ERROR:&nbsp;AddressSanitizer:&nbsp;heap-use-after-free&nbsp;on&nbsp;address&nbsp;0x6030000082c0&nbsp;at&nbsp;pc&nbsp;0x55b4b9659551&nbsp;bp&nbsp;0x7ffdf8a9c190&nbsp;sp&nbsp;0x7ffdf8a9c180&lt;br&gt;READ&nbsp;of&nbsp;size&nbsp;8&nbsp;at&nbsp;0x6030000082c0&nbsp;thread&nbsp;T0&lt;br&gt;   &nbsp;#0&nbsp;0x55b4b9659550&nbsp;in&nbsp;OpenThreads::ScopedPointerLock&lt;OpenThreads::Mutex&gt;::ScopedPointerLock(OpenThreads::Mutex*)&nbsp;./openmw/extern-git/OpenSceneGraph/include/OpenThreads/ScopedLock:54&lt;br&gt;   &nbsp;#1&nbsp;0x55b4b9659550&nbsp;in&nbsp;osg::StateAttribute::removeParent(osg::StateSet*)&nbsp;./openmw/extern-git/OpenSceneGraph/src/osg/StateAttribute.cpp:38&lt;br&gt;   &nbsp;#2&nbsp;0x55b4b965a033&nbsp;in&nbsp;osg::StateSet::clear()&nbsp;./openmw/extern-git/OpenSceneGraph/src/osg/StateSet.cpp:734&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Given&nbsp;the&nbsp;stack&nbsp;trace&nbsp;it&nbsp;kinda&nbsp;looks&nbsp;like&nbsp;the&nbsp;getRefMutex()&nbsp;call&nbsp;in&nbsp;StateAttribute.cpp&nbsp;is&nbsp;the&nbsp;where&nbsp;things&nbsp;might&nbsp;be&nbsp;going&nbsp;astray&nbsp;(note&nbsp;the&nbsp;comment&nbsp;I&#39;ve&nbsp;added&nbsp;below):&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;void&nbsp;StateAttribute::removeParent(osg::StateSet*&nbsp;object)&lt;br&gt;{&lt;br&gt; &nbsp; &nbsp;OpenThreads::ScopedPointerLock&lt;OpenThreads::Mutex&gt;&nbsp;lock(getRefMutex());&nbsp;//&nbsp;calls&nbsp;the&nbsp;base&nbsp;classes&nbsp;Referenced::getRefMutex()&nbsp;method&nbsp;that&nbsp;will&nbsp;map&nbsp;to&nbsp;Referenced::getGlobalReferencedMutex&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;ParentList::iterator&nbsp;pitr&nbsp;=&nbsp;std::find(_parents.begin(),_parents.end(),object);&lt;br&gt; &nbsp; &nbsp;if&nbsp;(pitr!=_parents.end())&nbsp;_parents.erase(pitr);&lt;br&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;Referenced::getGlobalReferencedMutex()&nbsp;implementation&nbsp;in&nbsp;Referenced.cpp&nbsp;is:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;OpenThreads::Mutex*&nbsp;Referenced::getGlobalReferencedMutex()&lt;br&gt;{&lt;br&gt; &nbsp; &nbsp;static&nbsp;GlobalMutexPointer&nbsp;s_ReferencedGlobalMutext&nbsp;=&nbsp;new&nbsp;OpenThreads::Mutex;&lt;br&gt; &nbsp; &nbsp;return&nbsp;s_ReferencedGlobalMutext.get();&lt;br&gt;}&lt;br&gt;&lt;br&gt;//&nbsp;helper&nbsp;class&nbsp;for&nbsp;forcing&nbsp;the&nbsp;global&nbsp;mutex&nbsp;to&nbsp;be&nbsp;constructed&nbsp;when&nbsp;the&nbsp;library&nbsp;is&nbsp;loaded.&lt;br&gt;struct&nbsp;InitGlobalMutexes&lt;br&gt;{&lt;br&gt; &nbsp; &nbsp;InitGlobalMutexes()&lt;br&gt; &nbsp; &nbsp;{&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;Referenced::getGlobalReferencedMutex();&lt;br&gt; &nbsp; &nbsp;}&lt;br&gt;};&lt;br&gt;static&nbsp;InitGlobalMutexes&nbsp;s_initGlobalMutexes;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Which&nbsp;is&nbsp;all&nbsp;a&nbsp;bit&nbsp;hacky&nbsp;way&nbsp;of&nbsp;trying&nbsp;to&nbsp;get&nbsp;a&nbsp;singleton&#39;s&nbsp;_ReferencedGlobalMutext&nbsp;to&nbsp;construct&nbsp;before&nbsp;any&nbsp;other&nbsp;code&nbsp;calling&nbsp;getGlobalReferencedMutex()&nbsp;gets&nbsp;called.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;don&#39;t&nbsp;really&nbsp;know&nbsp;why&nbsp;a&nbsp;pointer&nbsp;is&nbsp;even&nbsp;being&nbsp;used&nbsp;here,&nbsp;it&#39;s&nbsp;not&nbsp;how&nbsp;I&#39;d&nbsp;write&nbsp;the&nbsp;code&nbsp;these&nbsp;days,&nbsp;but&nbsp;off&nbsp;the&nbsp;top&nbsp;of&nbsp;my&nbsp;head&nbsp;don&#39;t&nbsp;recall&nbsp;the&nbsp;derivation&nbsp;and&nbsp;motivations&nbsp;between&nbsp;all&nbsp;this&nbsp;code&nbsp;as&nbsp;it&nbsp;dates&nbsp;back&nbsp;to&nbsp;the&nbsp;earliest&nbsp;days&nbsp;of&nbsp;the&nbsp;OSG&nbsp;project,&nbsp;so&nbsp;almost&nbsp;two&nbsp;decades&nbsp;:-)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;What&nbsp;I&#39;d&nbsp;write&nbsp;today&nbsp;would&nbsp;simply&nbsp;be:&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;static&nbsp;OpenThreads::Mutex&nbsp;s_ReferencedGlobalMutex;&lt;br&gt;OpenThreads::Mutex*&nbsp;Referenced::getGlobalReferencedMutex()&lt;br&gt;{&lt;br&gt; &nbsp; &nbsp;return&nbsp;&amp;s_ReferencedGlobalMutex;&lt;br&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;You&nbsp;could&nbsp;try&nbsp;substituting&nbsp;this&nbsp;in. &nbsp;I&nbsp;will&nbsp;try&nbsp;a&nbsp;build&nbsp;here&nbsp;just&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;above&nbsp;works&nbsp;fine&nbsp;for&nbsp;standard&nbsp;OSG&nbsp;work. &nbsp;I&nbsp;don&#39;t&nbsp;expect&nbsp;this&nbsp;change&nbsp;to&nbsp;have&nbsp;any&nbsp;affect&nbsp;on&nbsp;your&nbsp;own&nbsp;code,&nbsp;if&nbsp;it&nbsp;does&nbsp;it&nbsp;suggest&nbsp;there&nbsp;is&nbsp;some&nbsp;issue&nbsp;with&nbsp;order&nbsp;of&nbsp;clean&nbsp;up&nbsp;of&nbsp;statics.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Robert.&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
